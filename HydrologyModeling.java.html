 	HydrologyModeling.java	 
/*
 * Copyright (c) 2008 ESRI
 *
 * All rights reserved under the copyright laws of the United States
 * and applicable international laws, treaties, and conventions.
 *
 * You may freely redistribute and use this sample code, with or
 * without modification, provided you include the original copyright
 * notice and use restrictions.
 * See use restrictions at /arcgis/java/samples/userestrictions.
 */
package arcgissamples.spatialanalyst;

import java.awt.Insets;
import java.awt.Menu;
import java.awt.MenuBar;
import java.awt.MenuItem;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.IOException;

import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JSplitPane;
import javax.swing.JToggleButton;
import javax.swing.JToolBar;

import com.esri.arcgis.beans.TOC.TOCBean;
import com.esri.arcgis.beans.map.MapBean;
import com.esri.arcgis.carto.FeatureLayer;
import com.esri.arcgis.carto.LineElement;
import com.esri.arcgis.carto.Map;
import com.esri.arcgis.carto.MarkerElement;
import com.esri.arcgis.carto.RasterLayer;
import com.esri.arcgis.carto.RasterUniqueValueRenderer;
import com.esri.arcgis.carto.esriViewDrawPhase;
import com.esri.arcgis.controls.IMapControlEvents2Adapter;
import com.esri.arcgis.controls.IMapControlEvents2OnMouseDownEvent;
import com.esri.arcgis.controls.IMapControlEvents2OnMouseUpEvent;
import com.esri.arcgis.controls.esriControlsMousePointer;
import com.esri.arcgis.datasourcesraster.IEnumRasterBand;
import com.esri.arcgis.datasourcesraster.Raster;
import com.esri.arcgis.datasourcesraster.RasterBand;
import com.esri.arcgis.datasourcesraster.RasterDataset;
import com.esri.arcgis.datasourcesraster.RasterWorkspace;
import com.esri.arcgis.datasourcesraster.RasterWorkspaceFactory;
import com.esri.arcgis.display.IFillSymbol;
import com.esri.arcgis.display.RgbColor;
import com.esri.arcgis.display.SimpleLineSymbol;
import com.esri.arcgis.display.SimpleMarkerSymbol;
import com.esri.arcgis.display.esriSimpleLineStyle;
import com.esri.arcgis.display.esriSimpleMarkerStyle;
import com.esri.arcgis.geodatabase.FeatureClass;
import com.esri.arcgis.geodatabase.IFeatureClass;
import com.esri.arcgis.geodatabase.IGeoDataset;
import com.esri.arcgis.geodatabase.IRasterDataset;
import com.esri.arcgis.geodatabase.IWorkspace;
import com.esri.arcgis.geometry.IEnvelope;
import com.esri.arcgis.geometry.IGeometryCollection;
import com.esri.arcgis.geometry.Multipoint;
import com.esri.arcgis.geometry.Point;
import com.esri.arcgis.spatialanalyst.RasterDistanceOp;
import com.esri.arcgis.spatialanalyst.RasterExtractionOp;
import com.esri.arcgis.spatialanalyst.RasterHydrologyOp;
import com.esri.arcgis.system.AoInitialize;
import com.esri.arcgis.system.EngineInitializer;
import com.esri.arcgis.system.esriLicenseExtensionCode;
import com.esri.arcgis.system.esriLicenseProductCode;

public class HydrologyModeling extends JFrame {
    MapBean map;
    TOCBean toc;
    FlowDirectionDialog flowDirectionDialog;
    IdentifySinkDialog identifySinkDialog;
    FillSinkDialog fillSinkDialog;
    FlowAccumulationDialog flowAccumulationDialog;
    StreamNetworkDialog streamNetworkDialog;
    WatershedDialog watershedDialog;
    PropertyDialog propertyDialog;
    RasterBrowser browser;
    JToolBar toolbar;
    JButton addData;
    JToggleButton zoominButton;
    JToggleButton watershedButton;
    JToggleButton raindropButton;
    ImageIcon icon1 = new ImageIcon(this.getClass().getResource("icons/watershed.gif"));
    ImageIcon icon2 = new ImageIcon(this.getClass().getResource("icons/raindrop.gif"));
    ImageIcon icon3 = new ImageIcon(this.getClass().getResource("icons/AddData.gif"));
    ImageIcon icon4 = new ImageIcon(this.getClass().getResource("icons/zoomin.gif"));
    ImageIcon icon5 = new ImageIcon(this.getClass().getResource("icons/fullext.gif"));

    public HydrologyModeling() {
        init();
        createToolBar();
        createMenuBar();
        JSplitPane splitpane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT,toc,map);
        splitpane.setDividerLocation(150);
        getContentPane().add(splitpane, "Center");
        getContentPane().add(toolbar,"North");
    }

    /**
     * Set TOC Buddy Control
     */
    private void setBuddyControl() {
        try {
            toc.setBuddyControl(map);
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }
    /**
     * create the tool bar
     */
    private void createToolBar() {
        toolbar = new JToolBar();

        zoominButton = new JToggleButton(icon4);
        zoominButton.setMargin(new Insets(1,1,1,1));
        zoominButton.setEnabled(false);
        zoominButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                try {
                    if (zoominButton.isSelected()) {
                        raindropButton.setSelected(false);
                        watershedButton.setSelected(false);
                        map.setMousePointer(esriControlsMousePointer.esriPointerZoomIn);
                    } else {
                        map.setMousePointer(esriControlsMousePointer.esriPointerDefault);
                    }
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        });

        final JButton fullextButton = new JButton(icon5);
        fullextButton.setMargin(new Insets(1,1,1,1));
        fullextButton.setEnabled(false);
        fullextButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                try {
                    map.setExtent(map.getFullExtent());
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        });

        addData = new JButton(icon3);
        addData.setMargin(new Insets(1,1,1,1));
        addData.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                getBrowser().setVisible(true);
                IRasterDataset raster = getBrowser().getRaster();
                if ( raster != null ) {
                    try {
                        RasterLayer layer = new RasterLayer();
                        layer.createFromDataset(raster);
                        map.addLayer(layer, 0);
                        fullextButton.setEnabled(true);
                        zoominButton.setEnabled(true);
                    } catch (Exception ex) {
                        ex.printStackTrace();
                    }
                }
            }
        });

        watershedButton = new JToggleButton(icon1);
        raindropButton = new JToggleButton(icon2);
        watershedButton.setMargin(new Insets(1,1,1,1));
        raindropButton.setMargin(new Insets(1,1,1,1));
        watershedButton.setEnabled(false);
        raindropButton.setEnabled(false);
        watershedButton.setToolTipText("Watershed");
        watershedButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                try {
                    if (watershedButton.isSelected()) {
                        zoominButton.setSelected(false);
                        raindropButton.setSelected(false);
                        map.setMousePointer(esriControlsMousePointer.esriPointerCrosshair);
                    }
                    else {
                        map.setMousePointer(esriControlsMousePointer.esriPointerDefault);
                    }
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        });

        raindropButton.setToolTipText("Rain drop");
        raindropButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                try {
                    if (raindropButton.isSelected()) {
                        map.setMousePointer(esriControlsMousePointer.esriPointerCrosshair);
                        zoominButton.setSelected(false);
                        watershedButton.setSelected(false);
                    }
                    else {
                        map.setMousePointer(esriControlsMousePointer.esriPointerDefault);
                    }
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        });

        toolbar.add(addData);
        toolbar.add(fullextButton);
        toolbar.add(zoominButton);
        toolbar.addSeparator();
        toolbar.add(watershedButton);
        toolbar.add(raindropButton);
    }

    private RasterBrowser getBrowser() {
        if ( browser == null ) {
            browser = RasterBrowser.getRasterBrowser();
            browser.pack();
        }
        browser.setLocationRelativeTo(this);
        return browser;
    }

    /**
     * Create the menu bar.
     */
    private void createMenuBar() {
        MenuBar menuBar = new MenuBar();
        setMenuBar(menuBar);

        Menu hydrologyMenu = new Menu("Hydrology");
        menuBar.add(hydrologyMenu);
        MenuItem flowDirectionMenuItem = new MenuItem("Flow Direction...");
        MenuItem identifySinksMenuItem = new MenuItem("Identify Sinks...");
        MenuItem fillSinksMenuItem = new MenuItem("Fill Sinks...");
        MenuItem flowAccumulationMenuItem = new MenuItem("Flow Accumulation...");
        MenuItem watershedMenuItem = new MenuItem("Watershed...");
        MenuItem streamMenuItem = new MenuItem("Stream Network As Feature...");
        MenuItem propertyMenuItem = new MenuItem("Interactive Propreties...");

        flowDirectionMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                createFlowDirection();
            }
        });

        identifySinksMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                identifySink();
            }
        });

        fillSinksMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                fillSink();
            }
        });

        flowAccumulationMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                flowAccumulation();
            }
        });

        streamMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                streamNetwork();
            }
        });

        watershedMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                watershed();
            }
        });

        propertyMenuItem.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                interactiveproperty();
            }
        });

        hydrologyMenu.add(flowDirectionMenuItem);
        hydrologyMenu.addSeparator();
        hydrologyMenu.add(identifySinksMenuItem);
        hydrologyMenu.add(fillSinksMenuItem);
        hydrologyMenu.addSeparator();
        hydrologyMenu.add(flowAccumulationMenuItem);
        hydrologyMenu.addSeparator();
        hydrologyMenu.add(watershedMenuItem);
        hydrologyMenu.add(streamMenuItem);
        hydrologyMenu.addSeparator();
        hydrologyMenu.add(propertyMenuItem);
    }

    /**
     * get interactive properties
     */
    private void interactiveproperty() {
        try {
            getPropertyDialog().clearDataset();
            for (int i = 0; i < map.getLayerCount(); i++) {
                try {
                    String name = ((RasterLayer) map.getLayer(i)).getFilePath();
                    getPropertyDialog().addDataset(name);
                } catch (Exception ex) {}
            }
            getPropertyDialog().setVisible(true);
            String direction = getPropertyDialog().getFlowDirection();
            String accumulation = getPropertyDialog().getFlowAccumulation();
            if ( direction != null && accumulation != null ) {
                watershedButton.setEnabled(true);
                raindropButton.setEnabled(true);
            } else {
                watershedButton.setEnabled(false);
                raindropButton.setEnabled(false);
            }
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private PropertyDialog getPropertyDialog() {
        if ( propertyDialog == null ) {
            propertyDialog = new PropertyDialog();
            propertyDialog.setLocationRelativeTo(this);
        }
        return propertyDialog;
    }

    /**
     * Create watershed
     */
    private void watershed() {
        try {
            getWatershedDialog().setVisible(true);
            IGeoDataset result = getWatershedDialog().getResult();
            String output = getWatershedDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //

            if ( result != null) {
                RasterLayer layer = new RasterLayer();
                Raster raster = (Raster)(result);
                if ( output != null && (! output.equals("<Temporary>")) ) {
                    IRasterDataset dataset = saveRaster(raster, output);
                    layer.createFromDataset(dataset);
                } else {
                    layer.createFromRaster(raster);
                    int count = 1;
                    for (int i = 0; i < map.getLayerCount(); i++) {
                        if (map.getLayer(i).getName().startsWith("Watershed"))
                            count++;
                    }
                    layer.setName("Watershed" + count);
                }
                map.addLayer(layer, 0);
            } else {
                System.out.println("Getting the watershed did not work");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private WatershedDialog getWatershedDialog() {
        if ( watershedDialog == null ) {
            watershedDialog = new WatershedDialog();
            watershedDialog.setLocationRelativeTo(this);
        }
        return watershedDialog;
    }

    /**
     * Create stream network
     */
    private void streamNetwork() {
        try {
            getStreamNetworkDialog().setVisible(true);
            IGeoDataset result = getStreamNetworkDialog().getResult();
            String output = getStreamNetworkDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //
            if ( result != null) {
                IFeatureClass featureClass = (FeatureClass) result;
                FeatureLayer layer = new FeatureLayer();
                try { // to rename dataset
                    if (output != null && (!output.equals("<Default>"))) {
                        RasterDataset dataset = (RasterDataset) result;
                        if (dataset.canRename()) {
                            File file = new File(output);
                            System.out.println("Rename dataset to: " + file.getName());
                            dataset.rename(file.getName());
                        }
                    }
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
                layer.setFeatureClassByRef(featureClass);
                layer.setName(((RasterDataset)result).getBrowseName());
                map.addLayer(layer, 0);
            } else {
                System.out.println("Getting the stream network did not work");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private StreamNetworkDialog getStreamNetworkDialog() {
        if ( streamNetworkDialog == null ) {
            streamNetworkDialog = new StreamNetworkDialog();
            streamNetworkDialog.setLocationRelativeTo(this);
        }
        return streamNetworkDialog;
    }

    /**
     * Create flow accumulation
     */
    private void flowAccumulation() {
        try {
            getFlowAccumulationDialog().setVisible(true);
            IGeoDataset result = getFlowAccumulationDialog().getResult();
            String output = getFlowAccumulationDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //
            if ( result != null) {
                RasterLayer layer = new RasterLayer();
                Raster raster = (Raster)result;
                if ( output != null && (! output.equals("<Temporary>")) ) {
                    IRasterDataset dataset = saveRaster(raster, output);
                    layer.createFromDataset(dataset);
                } else {
                    layer.createFromRaster(raster);
                    int count = 1;
                    for (int i = 0; i < map.getLayerCount(); i++) {
                        if (map.getLayer(i).getName().startsWith("Flow Accumulation"))
                            count++;
                    }
                    layer.setName("Flow Accumulation" + count);
                }
                map.addLayer(layer, 0);
            } else {
                System.out.println("Getting the flow accumulation did not work");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private FlowAccumulationDialog getFlowAccumulationDialog() {
        if ( flowAccumulationDialog == null ) {
            flowAccumulationDialog = new FlowAccumulationDialog();
            flowAccumulationDialog.setLocationRelativeTo(this);
        }
        return flowAccumulationDialog;
    }

    /**
     * Fill sinks
     */
    private void fillSink() {
        try {
            getFillSinkDialog().setVisible(true);
            IGeoDataset result = getFillSinkDialog().getResult();
            String output = getFillSinkDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //
            if ( result != null) {
                RasterLayer layer = new RasterLayer();
                Raster raster = (Raster) result;
                if ( output != null && (! output.equals("<Temporary>")) ) {
                    IRasterDataset dataset = saveRaster(raster, output);
                    layer.createFromDataset(dataset);
                } else {
                    layer.createFromRaster(raster);
                    int count = 1;
                    for (int i = 0; i < map.getLayerCount(); i++) {
                        if (map.getLayer(i).getName().startsWith("Fill Sinks"))
                            count++;
                    }
                    layer.setName("Fill Sinks" + count);
                }
                map.addLayer(layer, 0);
            } else {
                System.out.println("Filling the sinks did not work");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private FillSinkDialog getFillSinkDialog() {
        if ( fillSinkDialog == null ) {
            fillSinkDialog = new FillSinkDialog();
            fillSinkDialog.setLocationRelativeTo(this);
        }
        return fillSinkDialog;
    }

    /**
     * Identify sinks
     */
    private void identifySink() {
        try {
            getIdentifySinkDialog().setVisible(true);
            IGeoDataset result = getIdentifySinkDialog().getResult();
            String output = getIdentifySinkDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //
            if ( result != null) {
                RasterLayer layer = new RasterLayer();
                Raster raster = (Raster) result;
                if ( output != null && (! output.equals("<Temporary>")) ) {
                    IRasterDataset dataset = saveRaster(raster, output);
                    layer.createFromDataset(dataset);
                } else {
                    layer.createFromRaster(raster);
                    int count = 1;
                    for (int i = 0; i < map.getLayerCount(); i++) {
                        if (map.getLayer(i).getName().startsWith("Identified Sinks"))
                            count++;
                    }
                    layer.setName("Identified Sinks" + count);
                }
                map.addLayer(layer, 0);
            } else {
                System.out.println("Identifying the sinks did not work");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private IdentifySinkDialog getIdentifySinkDialog() {
        if ( identifySinkDialog == null ) {
            identifySinkDialog = new IdentifySinkDialog();
            identifySinkDialog.setLocationRelativeTo(this);
        }
        return identifySinkDialog;
    }

    /**
     * Create flow direction based on input surface and add the result
     * as a rasterlayer to the map
     */
    private void createFlowDirection() {
        try {
            getFlowDirectionDialog().setVisible(true);
            IGeoDataset result = getFlowDirectionDialog().getResult();
            String output = getFlowDirectionDialog().getOutput();
            //
            // Now that we have the result of the operation we need to add it to the display.
            // First make a layer to hold the resulting raster and then add it to the map.
            //
            if ( result != null) {
                RasterLayer layer = new RasterLayer();
                Raster raster = (Raster) result;
                if ( output != null && (! output.equals("<Temporary>")) ) {
                    IRasterDataset dataset = saveRaster(raster, output);
                    layer.createFromDataset(dataset);
                } else {
                    layer.createFromRaster(raster);
                    int count = 1;
                    for (int i = 0; i < map.getLayerCount(); i++) {
                        if (map.getLayer(i).getName().startsWith("Flow Direction"))
                            count++;
                    }
                    layer.setName("Flow Direction" + count);
                }
                map.addLayer(layer, 0);
            } else {
                System.out.println("Creating the flow direction did not work");
            }
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private FlowDirectionDialog getFlowDirectionDialog() {
        if ( flowDirectionDialog == null ) {
            flowDirectionDialog = new FlowDirectionDialog();
            flowDirectionDialog.setLocationRelativeTo(this);
        }
        return flowDirectionDialog;
    }

    private IRasterDataset saveRaster (Raster raster, String output) throws IOException {
        File file = new File(output);
        RasterWorkspaceFactory factory = new RasterWorkspaceFactory();
        IWorkspace workspace = factory.openFromFile(file.getParent(), 0);

        // decide the output format based on file extension
        String format;
        if (output.toLowerCase().endsWith(".tif")) {
            format = "TIFF";
        }
        else if (output.toLowerCase().endsWith(".img")) {
            format = "IMAGINE Image";
        }
        else {
            format = "GRID";
        }

        // write the flow directory raster to user specified file
        raster.saveAs(file.getName(), workspace, format);
        IRasterDataset dataset = new RasterWorkspace(workspace).openRasterDataset(file.getName());
        return dataset;
    }

    /**
     * Calculating rain drop interactively
     * @param x
     * @param y
     */
    private void interactiveRaindrop(double x, double y) {
        try {
            //
            // Make the point where we want the raindrop to fall
            Point pt = new Point();
            pt.putCoords(x,y);
            Multipoint points = new Multipoint();
            points.addPoint(pt,null,null);
            RasterDistanceOp rasterDistOp = new RasterDistanceOp();
            String directionName = propertyDialog.getFlowDirection();
            String accumulationName = propertyDialog.getFlowAccumulation();

            // open flow direction raster dataset
            File file = new File(directionName);
            RasterWorkspaceFactory factory = new RasterWorkspaceFactory();
            RasterWorkspace workspace = new RasterWorkspace(factory.openFromFile(file.getParent(),0));
            RasterDataset direction = (RasterDataset) workspace.openRasterDataset(file.getName());

            // open flow accumulation raster dataset
            file = new File(accumulationName);
            workspace = new RasterWorkspace(factory.openFromFile(file.getParent(),0));
            RasterDataset accumulation = (RasterDataset) workspace.openRasterDataset(file.getName());

            // Obain rain drop path
            IGeometryCollection geomCol = rasterDistOp.costPathAsPolyline(points, accumulation, direction);

            // define a color for both selected point and rain drop path
            RgbColor color = new RgbColor();
            color.setBlue(70);
            color.setRed(20);
            color.setGreen(255);

            // Define a maker symbol for the selected location
            SimpleMarkerSymbol symbol1 = new SimpleMarkerSymbol();
            symbol1.setStyle(esriSimpleMarkerStyle.esriSMSCircle);
            symbol1.setColor(color);
            symbol1.setSize(6);

            // Define line symbol
            SimpleLineSymbol symbol2 = new SimpleLineSymbol();
            symbol2.setColor(color);
            symbol2.setStyle(esriSimpleLineStyle.esriSLSSolid);
            symbol2.setWidth(2);

            // create a marker element
            MarkerElement marker = new MarkerElement();
            marker.setSymbol(symbol1);
            marker.setGeometry(pt);

            // create a line element
            LineElement line = new LineElement();
            line.setSymbol(symbol2);
            line.setGeometry(geomCol.getGeometry(0));

            // Add the path and selected location as graphics into map
            Map mapLocal = (Map) map.getMap();
            mapLocal.addElement(marker,0);
            mapLocal.addElement(line,0);
            // now refresh the map
            mapLocal.partialRefresh(esriViewDrawPhase.esriViewGraphics,null,null);
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    /**
     * Calculating watershed interactively
     * @param x
     * @param y
     */
    private void interactiveWatershed(double x, double y) {
        try {
            //get the point the user clicked and get the rasters to work with
            Point pt = new Point();
            pt.putCoords(x,y);
            Multipoint points = new Multipoint();
            points.addPoint(pt,null,null);

            String directionName = propertyDialog.getFlowDirection();
            String accumulationName = propertyDialog.getFlowAccumulation();

            // open flow direction raster dataset
            File file = new File(directionName);
            RasterWorkspaceFactory factory = new RasterWorkspaceFactory();
            RasterWorkspace workspace = new RasterWorkspace(factory.openFromFile(file.getParent(),0));
            RasterDataset direction = (RasterDataset) workspace.openRasterDataset(file.getName());

            // open flow accumulation raster dataset
            file = new File(accumulationName);
            workspace = new RasterWorkspace(factory.openFromFile(file.getParent(),0));
            RasterDataset accumulation = (RasterDataset) workspace.openRasterDataset(file.getName());

            // initialize Extraction Op and extract this point
            RasterExtractionOp rasterExtractOp = new RasterExtractionOp();
            //Get the point raster
            IGeoDataset sourceDataset = rasterExtractOp.points(accumulation, points, true);

            // nitialize Hydrology Op, snap to a point that has hightest
            // flow accumulation within a defined range
            RasterHydrologyOp hydroOp = new RasterHydrologyOp();


            // Snap to the highest flow accumulation point
            IGeoDataset pourDataset = sourceDataset;
            if ( propertyDialog.isSnapon() ) {
                IEnumRasterBand bands = accumulation.getBands();
                RasterBand band = new RasterBand(bands.IEnumRasterBand_next());
                if ( band != null ) {
                    double range = band.meanCellSize().getX();
                    pourDataset = hydroOp.snapPourPoint(sourceDataset, accumulation, 10 * range);
                }
            }

            // Calculate watershed
            Raster output = (Raster) hydroOp.watershed(direction, pourDataset);

            RasterLayer layer = new RasterLayer();
            layer.createFromRaster(output);

            // create a RasterUniqueValueRender for the layer
            RasterUniqueValueRenderer renderer = (RasterUniqueValueRenderer) layer.getRenderer();
            IFillSymbol symbol = (IFillSymbol)(renderer.getSymbol(0,0));

            // define color for the symbol
            RgbColor color = new RgbColor();
            color.setRed(255);
            color.setBlue(0);
            color.setGreen(0);
            symbol.setColor(color);

            // setting transparency  for the renderer which is associated with the layer
            renderer.setTransparencyValue(50);

            map.addLayer(layer, 0);
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private void init() {
        setTitle("Hydrology Modeling");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        try {
            AoInitialize aoint = new AoInitialize();
            aoint.initialize(esriLicenseProductCode.esriLicenseProductCodeEngine);
            aoint.checkOutExtension(esriLicenseExtensionCode.esriLicenseExtensionCodeSpatialAnalyst);
            map = new MapBean();
            toc = new TOCBean();
            map.addIMapControlEvents2Listener(new IMapControlEvents2Adapter() {
                public void onMouseUp(IMapControlEvents2OnMouseUpEvent e) {
                    if ( watershedButton.isEnabled() && watershedButton.isSelected() ) {
                        interactiveWatershed(e.getMapX(),e.getMapY());
                    } else if ( raindropButton.isEnabled() && raindropButton.isSelected() ) {
                        interactiveRaindrop(e.getMapX(),e.getMapY());
                    }
                }

                public void onMouseDown(IMapControlEvents2OnMouseDownEvent e) {
                    if ( zoominButton.isSelected() ) {
                        try {
                            IEnvelope env = map.trackRectangle();
                            map.setExtent(env);
                        }
                        catch (Exception ex) {
                            ex.printStackTrace();
                        }
                    }
                }
            });
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    public static void main(String[] args) {
        EngineInitializer.initializeVisualBeans();
        final HydrologyModeling app = new HydrologyModeling();
        app.setSize(650,500);
        app.setVisible(true);
        try {
            app.setBuddyControl();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }
}